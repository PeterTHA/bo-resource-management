# คู่มือการอัพเกรดฐานข้อมูล Position และ Position Level

ในการอัพเกรดฐานข้อมูลครั้งนี้ เราได้ปรับปรุงโครงสร้างฐานข้อมูลเพื่อให้ตาราง employees ใช้ Foreign Key สำหรับเชื่อมโยงกับตาราง positions และ position_levels แทนที่จะเก็บค่า code โดยตรง

## ขั้นตอนการอัพเกรด

1. **อัพเดต Schema ของ Prisma**
   - เพิ่มฟิลด์ position_id และ position_level_id ในตาราง employees
   - สร้างความสัมพันธ์ (relation) กับตาราง positions และ position_levels

2. **อัพเดตข้อมูลที่มีอยู่**
   - เรียกใช้ API `/api/migrate-position` เพื่ออัพเดตข้อมูลพนักงานที่มีอยู่ให้มีค่า position_id และ position_level_id จากค่า position และ position_level เดิม

3. **ลบฟิลด์เดิม**
   - หลังจากอัพเดตข้อมูลเรียบร้อยแล้ว ให้เรียกใช้ migration เพื่อลบฟิลด์ position และ position_level ออกจากตาราง employees
   - ใช้ไฟล์ migration `20250411161500_remove_position_columns`

## วิธีการใช้งาน

1. **ติดตั้ง Prisma CLI**
   ```bash
   npm install -g prisma
   ```

2. **อัพเดตข้อมูลพนักงาน**
   - เข้าสู่ระบบด้วยบัญชีผู้ดูแลระบบ
   - เรียกใช้ API: `GET /api/migrate-position`
   - ตรวจสอบผลลัพธ์ว่าสำเร็จหรือไม่

3. **รัน Migration**
   ```bash
   cd <project_directory>
   prisma migrate resolve --applied 20250411161500_remove_position_columns
   prisma migrate deploy
   ```

4. **ตรวจสอบและยืนยัน**
   - ตรวจสอบว่าระบบสามารถแสดงข้อมูลตำแหน่งและระดับตำแหน่งได้ถูกต้อง
   - ทดสอบการเพิ่มและแก้ไขพนักงาน

## การกลับไปใช้เวอร์ชันเดิม

หากพบปัญหา คุณสามารถกลับไปใช้เวอร์ชันเดิมได้โดย:

1. **กู้คืนฐานข้อมูล** จาก backup (ควรทำ backup ก่อนเริ่มอัพเกรด)
2. **กลับไปใช้โค้ดเวอร์ชันก่อนหน้า**

## หมายเหตุ

การอัพเกรดนี้เป็นการเปลี่ยนแปลงโครงสร้างข้อมูลที่สำคัญ ควรทำการสำรองข้อมูลก่อนดำเนินการและทดสอบระบบอย่างครบถ้วนหลังการอัพเกรด 